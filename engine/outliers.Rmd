# Análise da qualidade dos dados

```{r passo1, cache=TRUE}
# o gráfico
# as cores:
# Neste caso, temos 20 cat, mas somente 9 cores na paleta brewer padrao

colourCount = length(unique(totais$tipo))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))


plt.p1 <- ggplot(totais, aes(x=mes, y=total.raw, group=tipo, colour=tipo,
                text = paste(ano, "-", mes, 
                             "<br>", tipo,
                             "<br>", total)))
                             
                             
plt.p1 <- plt.p1 +  geom_line() + geom_point() +
                scale_colour_manual(values = getPalette(colourCount))+
                facet_grid(ano ~., scale = "free") + 
                labs(title="Gastos por tipo de despesa - dados não-filtrados",
                     y="Total (R$)", x="Mês") + 
                theme(legend.position="bottom") +
                theme(plot.title = element_text(hjust = 0.5)) 

ggplotly(plt.p1, tooltip = "text")
```

Analisando este gráfico, verificamos um outlier em março de 2015, tipo pagamentos. 

Vamos olhar esta informação mais de perto:


```{r, cache=TRUE}

# vamos ver do q se trata, para talvez remover do gráfico

sub <- with(dadosT, ano==2015 & mes=="Mar" & tipo=="pagamentos" )
dados <- dadosT[sub,c(1,5,6,8)]
kable(dados, caption = "categoria pagamentos, em março de 2015")
```

Da tabela acima, observa-se que consta um lançamento referente a pagamento de cartão de crédito. Porém não é assim que o restante dos lançamentos foram feitos: não foram registrados totais. Este, portanto, foi um erro de uso da plataforma. Podemos, portanto, retirar este outlier com segurança.



```{r}

# subset de 2 meses quaisquer, para mostrar que todas as compras no cc são registradas como feitas no dia 25

sub <- with(dadosT, mes %in% c("Jun","Jul") & day(dadosT$data) == 25)
dadosub <- dadosT[which(sub),]

kable(head(dadosub[unique(dadosub$tipo),c(1,5,6,8)]), caption = "compras no crédito, registradas no dia 25")

kable(tail(dadosub[unique(dadosub$tipo),c(1,5,6,8)]), caption = "compras no crédito, registradas no dia 25")

```

Além disso, verifica-se que todas as despesas pagas no cartão de crédito ficaram registradas na data de vencimento do cartão, dia 25. Este é um defeito da plataforma.


Desta forma, não é possível dizer se a despesa foi feita no mês anterior ou no próprio mês. Ela apenas foi paga no mês onde é lançada. 

Uma vez que a fatura deste cartão é fechada no dia 15, todas as compras realizadas a partir do dia 16 são cobradas apenas na próxima fatura. 

No entanto, como isso ocorre para todos os dados da mesma forma, não há impacto impeditivo na análise.

```{r filtra-dados, cache=TRUE}

# retirando ponto do db
sub <- with(dadosT, ano==2015 & mes=="Mar" & tipo=="pagamentos" & valor.raw > 4000)
dadosFil <- dadosT[which(!sub),]
dadosFil <- group_by(dadosFil, tipo, ano, mes)
totais <- summarise(dadosFil, total.raw=sum(valor.raw)) %>%
                mutate(media.raw = mean(total.raw), 
                       total = real(total.raw),
                       media = real(media.raw))


rm(dadosT) # house cleanning

```



```{r passo2, cache=TRUE}
plt.p2 <- ggplot(totais, aes(x=mes, y=total.raw, group=tipo, colour=tipo,
                text = paste(ano, "-", mes, 
                             "<br>", tipo,
                             "<br>", total)))
        
plt.p2 <- plt.p2 +  geom_line() + geom_point() +
                scale_colour_manual(values = getPalette(colourCount))+
                facet_grid(ano ~., scale="free") + 
                labs(title="Gastos por tipo de despesa - dados filtrados", 
                     y="Total (R$)", x="Mês") + 
        
                theme(legend.title=element_blank()) +
                theme(legend.position="bottom") +
                guides(fill=guide_legend(nrow=5, byrow=TRUE)) +
                theme(plot.title = element_text(hjust = 0.5)) 

ggplotly(plt.p2, tooltip = "text")

```

Como podemos ver no gráfico 2, não há mais outliers, todos os erros de coleta dados foram filtrados. 

O próximo passo é estudar os tipos de despesas que mais se destacam.


```{r grid, fig.height=10, fig.cap="Tratamento dos dados", cache=TRUE}

# # fig.width=10, fig.height=10
# grid.arrange(plt.p1, plt.p2,  
#              nrow=2, ncol=1)
# grid.rect(gp=gpar(fill=NA))
```

